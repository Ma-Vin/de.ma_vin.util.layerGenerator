package de.ma_vin.util.layer.generator.generator;

import de.ma_vin.util.layer.generator.config.elements.Entity;
import de.ma_vin.util.layer.generator.config.elements.Models;
import de.ma_vin.util.layer.generator.config.elements.Reference;
import de.ma_vin.util.layer.generator.log.LogImpl;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;

import java.io.BufferedWriter;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;
import static org.mockito.Mockito.when;

public class AccessMapperCreatorTest extends AbstractCreatorTest {

    public static final String GROUPING_NAME = "grouping";
    public static final String MAPPER_PACKAGE_NAME = BASE_PACKAGE + ".mapper";
    public static final String DAO_PACKAGE_NAME = BASE_PACKAGE + ".dao";
    public static final String DOMAIN_PACKAGE_NAME = BASE_PACKAGE + ".domain";
    private AccessMapperCreator cut;
    private final List<Entity> entities = new ArrayList<>();

    @Mock
    private Entity parentEntity;
    @Mock
    private Reference toParentReference;
    @Mock
    private Reference fromParentReference;
    @Mock
    private Entity anotherParentEntity;
    @Mock
    private Reference anotherToParentReference;
    @Mock
    private Reference anotherFromParentReference;

    @Mock
    private Entity subEntity;
    @Mock
    private Reference toSubReference;
    @Mock
    private Reference fromSubReference;

    @Override
    @BeforeEach
    public void setUp() {
        super.setUp();
        cut = new AccessMapperCreator(config, new LogImpl()) {
            @Override
            protected BufferedWriter createBufferedWriter(File classFile) {
                List<String> fileContent = new ArrayList<>();
                writtenFileContents.put(classFile.getName(), fileContent);
                try {
                    // Assumption: after write is als a newLine statement
                    doAnswer(a -> fileContent.add(a.getArgument(0))).when(bufferedWriter).write(anyString());
                } catch (IOException e) {
                    e.printStackTrace();
                }
                return bufferedWriter;
            }

            @Override
            protected File createFile(File dir, String fileName) {
                File createdFile = mock(File.class);
                when(createdFile.getName()).thenReturn(fileName);
                when(createdFile.getParentFile()).thenReturn(dir);
                return createdFile;
            }
        };

        entities.clear();
        entities.add(entity);
    }

    @Override
    protected void initDefaultMock() {
        super.initDefaultMock();

        when(grouping.getGroupingPackage()).thenReturn(GROUPING_NAME);

        when(parentEntity.getBaseName()).thenReturn("Owner");
        when(parentEntity.getDescription()).thenReturn("Owner description");
        when(parentEntity.getIdentificationPrefix()).thenReturn("OW");
        when(parentEntity.getModels()).thenReturn(Models.DOMAIN_DAO_DTO);
        when(parentEntity.getGrouping()).thenReturn(null);
        when(parentEntity.hasParent()).thenReturn(Boolean.FALSE);
        when(parentEntity.hasNoParent()).thenReturn(Boolean.TRUE);
        when(parentEntity.getReferences()).thenReturn(Collections.singletonList(fromParentReference));

        setMockReturnsReference(toParentReference, "dummy", "Owner", null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(toParentReference, null, parentEntity, null);
        setMockReturnsReference(fromParentReference, "dummy", null, null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(fromParentReference, parentEntity, null, null);

        when(anotherParentEntity.getBaseName()).thenReturn("AnotherOwner");
        when(anotherParentEntity.getDescription()).thenReturn("Another owner description");
        when(anotherParentEntity.getIdentificationPrefix()).thenReturn("AOW");
        when(anotherParentEntity.getModels()).thenReturn(Models.DOMAIN_DAO_DTO);
        when(anotherParentEntity.getGrouping()).thenReturn(null);
        when(anotherParentEntity.hasParent()).thenReturn(Boolean.FALSE);
        when(anotherParentEntity.hasNoParent()).thenReturn(Boolean.TRUE);
        when(anotherParentEntity.getReferences()).thenReturn(Collections.singletonList(anotherFromParentReference));

        setMockReturnsReference(anotherToParentReference, "anotherDummy", "AnotherOwner", null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(anotherToParentReference, null, anotherParentEntity, null);
        when(anotherToParentReference.isReverse()).thenReturn(Boolean.TRUE);
        setMockReturnsReference(anotherFromParentReference, "anotherDummy", null, null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(anotherFromParentReference, anotherParentEntity, null, null);

        when(subEntity.getBaseName()).thenReturn("Child");
        when(subEntity.getDescription()).thenReturn("child description");
        when(subEntity.getIdentificationPrefix()).thenReturn("CH");
        when(subEntity.getModels()).thenReturn(Models.DOMAIN_DAO_DTO);
        when(subEntity.getGrouping()).thenReturn(grouping);
        when(subEntity.hasParent()).thenReturn(Boolean.FALSE);
        when(subEntity.hasNoParent()).thenReturn(Boolean.TRUE);
        when(subEntity.getParentRefs()).thenReturn(Collections.singletonList(fromSubReference));

        setMockReturnsReference(toSubReference, "child", "Child", null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(toSubReference, null, subEntity, null);
        setMockReturnsReference(fromSubReference, "child", null, null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(fromSubReference, subEntity, null, null);
        when(fromSubReference.isReverse()).thenReturn(Boolean.TRUE);
    }

    @Test
    public void testCreateAccessMapper() {
        List<String> expected = getDefaultExpected();

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    private List<String> getDefaultExpected() {
        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        return expected;
    }

    @Test
    public void testCreateAccessMapperField() {
        when(entity.getFields()).thenReturn(Collections.singletonList(field));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		result.setAnyField(dummy.getAnyField());");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setAnyField(dummy.getAnyField());");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperSingleRef() {
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isList()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		GroupingAccessMapper.convertToTarget(dummy.getTargetRef(), result, mappedObjects);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		GroupingAccessMapper.convertToTargetDao(dummy.getTargetRef(), result, mappedObjects);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperSingleRefNotOwner() {
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isList()).thenReturn(Boolean.FALSE);
        when(targetReference.isOwner()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		result.setTargetRef(GroupingAccessMapper.convertToTarget(dummy.getTargetRef(), mappedObjects));");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRef(GroupingAccessMapper.convertToTargetDao(dummy.getTargetRef(), mappedObjects));");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiRef() {
        when(targetReference.getParent()).thenReturn(entity);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiRefOwnerAndNotOwner() {
        when(targetReference.getParent()).thenReturn(entity);
        Reference fromTargetReference = mock(Reference.class);
        setMockReturnsReference(fromTargetReference, "TargetRef", "Dummy", null, null, Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(fromTargetReference, targetEntity, entity, null);

        Reference anotherTargetReference = mock(Reference.class);
        setMockReturnsReference(anotherTargetReference, "TargetRef", "Target", null, null, Boolean.TRUE, Boolean.FALSE);
        setMockReturnsReference(anotherTargetReference, subEntity, targetEntity, null);

        Reference fromAnotherTargetReference = mock(Reference.class);
        setMockReturnsReference(fromAnotherTargetReference, "TargetRef", "Child", null, null, Boolean.TRUE, Boolean.FALSE);
        setMockReturnsReference(fromAnotherTargetReference, targetEntity, subEntity, null);


        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(subEntity.getReferences()).thenReturn(Collections.singletonList(anotherTargetReference));
        when(subEntity.getParentRefs()).thenReturn(Collections.emptyList());
        when(targetEntity.getParentRefs()).thenReturn(Arrays.asList(fromTargetReference, fromAnotherTargetReference));
        entities.add(subEntity);
        entities.add(targetEntity);


        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.ChildDao;");
        expected.add("import de.test.package.dao.grouping.ChildToTargetDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.dao.grouping.TargetDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Child;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import de.test.package.domain.grouping.Target;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Child convertToChild(ChildDao child, boolean includeChildren) {");
        expected.add("		return convertToChild(child, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Child convertToChild(ChildDao child, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (child == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Child\" + child.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Child) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Child result = new Child();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			child.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg.getTarget(), result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static ChildDao convertToChildDao(Child child, boolean includeChildren) {");
        expected.add("		return convertToChildDao(child, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static ChildDao convertToChildDao(Child child, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (child == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"ChildDao\" + child.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (ChildDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		ChildDao result = new ChildDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			child.getTargetRefs().forEach(arg -> {");
        expected.add("				ChildToTargetDao connectionTable = new ChildToTargetDao();");
        expected.add("				connectionTable.setChild(result);");
        expected.add("				connectionTable.setTarget(GroupingAccessMapper.convertToTargetDao(arg, mappedObjects));");
        expected.add("				result.getTargetRefs().add(connectionTable);");
        expected.add("			});");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Target convertToTarget(TargetDao target) {");
        expected.add("		return convertToTarget(target, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Target convertToTarget(TargetDao target, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (target == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Target\" + target.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Target) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Target result = new Target();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Target convertToTarget(TargetDao target, Child parent) {");
        expected.add("		return convertToTarget(target, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Target convertToTarget(TargetDao target, Child parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Target result = convertToTarget(target, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getTargetRefs().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Target convertToTarget(TargetDao target, Dummy parent) {");
        expected.add("		return convertToTarget(target, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Target convertToTarget(TargetDao target, Dummy parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Target result = convertToTarget(target, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getTargetRefs().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static TargetDao convertToTargetDao(Target target) {");
        expected.add("		return convertToTargetDao(target, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static TargetDao convertToTargetDao(Target target, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (target == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"TargetDao\" + target.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (TargetDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		TargetDao result = new TargetDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static TargetDao convertToTargetDao(Target target, ChildDao parent) {");
        expected.add("		return convertToTargetDao(target, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static TargetDao convertToTargetDao(Target target, ChildDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		TargetDao result = convertToTargetDao(target, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			ChildToTargetDao connectionTable = new ChildToTargetDao();");
        expected.add("			connectionTable.setTarget(result);");
        expected.add("			connectionTable.setChild(parent);");
        expected.add("			parent.getTargetRefs().add(connectionTable);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static TargetDao convertToTargetDao(Target target, DummyDao parent) {");
        expected.add("		return convertToTargetDao(target, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static TargetDao convertToTargetDao(Target target, DummyDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		TargetDao result = convertToTargetDao(target, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentDummy(parent);");
        expected.add("			parent.getTargetRefs().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiRefNotOwner() {
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isOwner()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.dao.grouping.DummyToTargetDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg.getTarget(), result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg -> {");
        expected.add("				DummyToTargetDao connectionTable = new DummyToTargetDao();");
        expected.add("				connectionTable.setDummy(result);");
        expected.add("				connectionTable.setTarget(GroupingAccessMapper.convertToTargetDao(arg, mappedObjects));");
        expected.add("				result.getTargetRefs().add(connectionTable);");
        expected.add("			});");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperParentSingleRef() {
        when(entity.getParentRefs()).thenReturn(Collections.singletonList(toParentReference));
        when(toParentReference.getParent()).thenReturn(entity);
        when(fromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(fromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);

        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isList()).thenReturn(Boolean.FALSE);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		GroupingAccessMapper.convertToTarget(dummy.getTargetRef(), result, mappedObjects);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		GroupingAccessMapper.convertToTargetDao(dummy.getTargetRef(), result, mappedObjects);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");
        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiParentSingleRef() {
        when(entity.getParentRefs()).thenReturn(Arrays.asList(toParentReference, anotherToParentReference));
        when(toParentReference.getParent()).thenReturn(entity);
        when(fromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(fromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);
        when(anotherToParentReference.getParent()).thenReturn(entity);
        when(anotherFromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(anotherFromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);

        when(toParentReference.isList()).thenReturn(Boolean.FALSE);
        when(anotherToParentReference.isList()).thenReturn(Boolean.FALSE);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.AnotherOwnerDao;");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.AnotherOwner;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, AnotherOwner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, AnotherOwner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.setAnotherDummy(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.setDummy(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, AnotherOwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, AnotherOwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentAnotherOwner(parent);");
        expected.add("			parent.setAnotherDummy(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.setDummy(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");
        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperParentMultiRef() {
        when(entity.getParentRefs()).thenReturn(Collections.singletonList(toParentReference));
        when(toParentReference.getParent()).thenReturn(entity);
        when(fromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(fromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);

        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(targetReference.getParent()).thenReturn(entity);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Owner parent) {");
        expected.add("		return convertToDummy(dummy, includeChildren, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, includeChildren, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, OwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, OwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, includeChildren, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiParentMultiRef() {
        when(entity.getParentRefs()).thenReturn(Arrays.asList(toParentReference, anotherToParentReference));
        when(toParentReference.getParent()).thenReturn(entity);
        when(fromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(fromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);
        when(anotherToParentReference.getParent()).thenReturn(entity);
        when(anotherFromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(anotherFromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.AnotherOwnerDao;");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.AnotherOwner;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, AnotherOwner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, AnotherOwner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getAnotherDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, AnotherOwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, AnotherOwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentAnotherOwner(parent);");
        expected.add("			parent.getAnotherDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiParentMultiRefOwnerAndNotOwner() {
        when(entity.getParentRefs()).thenReturn(Arrays.asList(toParentReference, anotherToParentReference));
        when(toParentReference.getParent()).thenReturn(entity);
        when(fromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(fromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);
        when(anotherToParentReference.getParent()).thenReturn(entity);
        when(anotherFromParentReference.getRealTargetEntity()).thenReturn(entity);
        when(anotherFromParentReference.getTargetEntity()).thenReturn(ENTITY_NAME);

        when(anotherToParentReference.isOwner()).thenReturn(Boolean.FALSE);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.AnotherOwnerDao;");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.AnotherOwner;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, AnotherOwner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, AnotherOwner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getAnotherDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, AnotherOwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, AnotherOwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			AnotherOwnerToDummyDao connectionTable = new AnotherOwnerToDummyDao();");
        expected.add("			connectionTable.setDummy(result);");
        expected.add("			connectionTable.setAnotherOwner(parent);");
        expected.add("			parent.getAnotherDummys().add(connectionTable);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.getDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperUseIdGenerator() {
        when(config.isUseIdGenerator()).thenReturn(Boolean.TRUE);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = dummy.getIdentification();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = dummy.getIdentification();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperSingleRefWithChildren() {
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isList()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(targetEntity.getReferences()).thenReturn(Collections.singletonList(toSubReference));
        when(toSubReference.getParent()).thenReturn(targetEntity);
        when(fromSubReference.getRealTargetEntity()).thenReturn(targetEntity);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		GroupingAccessMapper.convertToTarget(dummy.getTargetRef(), includeChildren, result, mappedObjects);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		GroupingAccessMapper.convertToTargetDao(dummy.getTargetRef(), includeChildren, result, mappedObjects);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }


    @Test
    public void testCreateAccessMapperSingleRefNotOwnerWithChildren() {
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isList()).thenReturn(Boolean.FALSE);
        when(targetReference.isOwner()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(targetEntity.getReferences()).thenReturn(Collections.singletonList(toSubReference));
        when(toSubReference.getParent()).thenReturn(targetEntity);
        when(fromSubReference.getRealTargetEntity()).thenReturn(targetEntity);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		result.setTargetRef(GroupingAccessMapper.convertToTarget(dummy.getTargetRef(), includeChildren, mappedObjects));");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRef(GroupingAccessMapper.convertToTargetDao(dummy.getTargetRef(), includeChildren, mappedObjects));");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiRefWithChildren() {
        when(targetReference.getParent()).thenReturn(entity);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(targetEntity.getReferences()).thenReturn(Collections.singletonList(toSubReference));
        when(toSubReference.getParent()).thenReturn(targetEntity);
        when(fromSubReference.getRealTargetEntity()).thenReturn(targetEntity);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg, true, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, true, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }


    @Test
    public void testCreateAccessMapperMultiRefNotOwnerWithChildren() {
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isOwner()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));
        when(targetEntity.getReferences()).thenReturn(Collections.singletonList(toSubReference));
        when(toSubReference.getParent()).thenReturn(targetEntity);
        when(fromSubReference.getRealTargetEntity()).thenReturn(targetEntity);

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.dao.grouping.DummyToTargetDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg.getTarget(), true, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setTargetRefs(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg -> {");
        expected.add("				DummyToTargetDao connectionTable = new DummyToTargetDao();");
        expected.add("				connectionTable.setDummy(result);");
        expected.add("				connectionTable.setTarget(GroupingAccessMapper.convertToTargetDao(arg, true, mappedObjects));");
        expected.add("				result.getTargetRefs().add(connectionTable);");
        expected.add("			});");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperGroupingWithDot() {
        when(grouping.getGroupingPackage()).thenReturn("group.subgroup");

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.group.subgroup.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.group.subgroup.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupSubgroupAccessMapper {");
        expected.add("");
        expected.add("	private GroupSubgroupAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupSubgroupAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupSubgroupAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupSubgroupAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, "group.subgroup", MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", "GroupSubgroup"), expected);
    }

    @Test
    public void testCreateAccessMapperNothingToMap() {
        when(entity.getModels()).thenReturn(Models.DTO);
        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));
        assertEquals(0, writtenFileContents.size(), "No Mapper should be generated for only dto");

        when(entity.getModels()).thenReturn(Models.DOMAIN);
        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));
        assertEquals(0, writtenFileContents.size(), "No Mapper should be generated for only domain");

        when(entity.getModels()).thenReturn(Models.DAO);
        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));
        assertEquals(0, writtenFileContents.size(), "No Mapper should be generated for only dao");
    }

    @Test
    public void testCreateAccessMapperNoAllToMap() {
        when(parentEntity.getModels()).thenReturn(Models.DOMAIN_DTO);
        when(subEntity.getModels()).thenReturn(Models.DAO);
        entities.add(parentEntity);
        entities.add(subEntity);

        List<String> expected = getDefaultExpected();

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiRefParentNotRelevant() {
        when(parentEntity.getModels()).thenReturn(Models.DOMAIN_DTO);
        when(entity.getParentRefs()).thenReturn(Collections.singletonList(toParentReference));

        List<String> expected = getDefaultExpected();

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperSingleRefParentNotRelevant() {
        when(entity.getParentRefs()).thenReturn(Collections.singletonList(toParentReference));
        when(toParentReference.isList()).thenReturn(Boolean.FALSE);
        when(parentEntity.getModels()).thenReturn(Models.DOMAIN_DTO);

        List<String> expected = getDefaultExpected();

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperMultiRefChildNotRelevant() {
        when(targetEntity.getModels()).thenReturn(Models.DOMAIN_DTO);
        when(targetReference.getParent()).thenReturn(entity);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));

        List<String> expected = getDefaultExpected();

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperSingleRefChildNotRelevant() {
        when(targetEntity.getModels()).thenReturn(Models.DOMAIN_DTO);
        when(targetReference.getParent()).thenReturn(entity);
        when(targetReference.isList()).thenReturn(Boolean.FALSE);
        when(entity.getReferences()).thenReturn(Collections.singletonList(targetReference));

        List<String> expected = getDefaultExpected();

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperAbstract() {
        when(entity.getIsAbstract()).thenReturn(Boolean.TRUE);

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));
        assertEquals(0, writtenFileContents.size(), "No Mapper should be generated for only dto");
    }

    @Test
    public void testCreateAccessMapperWithParent() {
        when(entity.getParent()).thenReturn("AnotherDummy");
        when(entity.getRealParent()).thenReturn(parentEntity);
        when(entity.hasParent()).thenReturn(Boolean.TRUE);
        when(entity.hasNoParent()).thenReturn(Boolean.FALSE);
        when(parentEntity.getIsAbstract()).thenReturn(Boolean.TRUE);
        when(parentEntity.getBaseName()).thenReturn("AnotherDummy");
        when(parentEntity.getReferences()).thenReturn(Collections.singletonList(toSubReference));
        when(parentEntity.getFields()).thenReturn(Collections.singletonList(field));
        when(toSubReference.getParent()).thenReturn(parentEntity);
        when(fromSubReference.getRealTargetEntity()).thenReturn(parentEntity);
        when(fromSubReference.getTargetEntity()).thenReturn("AnotherDummy");

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		result.setAnyField(dummy.getAnyField());");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getChilds().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToChild(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setAnyField(dummy.getAnyField());");
        expected.add("");
        expected.add("		result.setChilds(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getChilds().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToChildDao(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperAggregateRef() {
        setMockReturnsReference(targetReference, entity, targetEntity, field);
        setMockReturnsReference(targetReference, "TargetRef", "Target", "anyField", "ENUM_VALUE_A", Boolean.TRUE, Boolean.TRUE);
        Reference sameTargetReference = mock(Reference.class);
        setMockReturnsReference(sameTargetReference, entity, targetEntity, field);
        setMockReturnsReference(sameTargetReference, "AnotherTargetRef", "Target", "anyField", "ENUM_VALUE_B", Boolean.TRUE, Boolean.TRUE);

        when(field.getType()).thenReturn("SomeEnum");
        when(field.getTypePackage()).thenReturn("de.test.package.enums");
        when(entity.getReferences()).thenReturn(Arrays.asList(targetReference, sameTargetReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getAggTargets().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setAggTargets(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("			dummy.getAnotherTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperAggregateRefFilterIsNotDomain() {
        setMockReturnsReference(targetReference, entity, targetEntity, field);
        setMockReturnsReference(targetReference, "TargetRef", "Target", "anyField", "ENUM_VALUE_A", Boolean.TRUE, Boolean.TRUE);
        Reference sameTargetReference = mock(Reference.class);
        setMockReturnsReference(sameTargetReference, entity, targetEntity, field);
        setMockReturnsReference(sameTargetReference, "AnotherTargetRef", "Target", "anyField", "ENUM_VALUE_B", Boolean.TRUE, Boolean.TRUE);

        when(field.getModels()).thenReturn(Models.DAO);
        when(field.getType()).thenReturn("SomeEnum");
        when(field.getTypePackage()).thenReturn("de.test.package.enums");
        when(entity.getReferences()).thenReturn(Arrays.asList(targetReference, sameTargetReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import de.test.package.enums.SomeEnum;");
        expected.add("import java.util.ArrayList;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren) {");
        expected.add("		return convertToDummy(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, boolean includeChildren, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getAggTargets().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTarget(arg, result, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren) {");
        expected.add("		return convertToDummyDao(dummy, includeChildren, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, boolean includeChildren, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setAggTargets(new ArrayList<>());");
        expected.add("		if (includeChildren) {");
        expected.add("			dummy.getTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, SomeEnum.ENUM_VALUE_A, mappedObjects)");
        expected.add("			);");
        expected.add("			dummy.getAnotherTargetRefs().forEach(arg ->");
        expected.add("					GroupingAccessMapper.convertToTargetDao(arg, result, SomeEnum.ENUM_VALUE_B, mappedObjects)");
        expected.add("			);");
        expected.add("		}");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }


    @Test
    public void testCreateAccessMapperParentAggregateRef() {
        setMockReturnsReference(toParentReference, "someDummy", "Owner", "anyField", "ENUM_VALUE_A", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(toParentReference, entity, parentEntity, field);
        when(toParentReference.isReverse()).thenReturn(Boolean.TRUE);
        setMockReturnsReference(anotherToParentReference, "anotherDummy", "Owner", "anyField", "ENUM_VALUE_B", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(anotherToParentReference, entity, parentEntity, field);
        when(anotherToParentReference.isReverse()).thenReturn(Boolean.TRUE);

        setMockReturnsReference(fromParentReference, "someDummy", "Dummy", "anyField", "ENUM_VALUE_A", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(fromParentReference, parentEntity, entity, field);
        setMockReturnsReference(anotherFromParentReference, "anotherDummy", "Dummy", "anyField", "ENUM_VALUE_B", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(anotherFromParentReference, parentEntity, entity, field);

        when(field.getType()).thenReturn("SomeEnum");
        when(field.getTypePackage()).thenReturn("de.test.package.enums");
        when(entity.getParentRefs()).thenReturn(Arrays.asList(toParentReference, anotherToParentReference));
        when(entity.getFields()).thenReturn(Collections.singletonList(field));
        when(parentEntity.getReferences()).thenReturn(Arrays.asList(fromParentReference, anotherFromParentReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("import lombok.extern.log4j.Log4j2;");
        expected.add("");
        expected.add("@Log4j2");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		result.setAnyField(dummy.getAnyField());");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			switch (dummy.getAnyField()) {");
        expected.add("				case ENUM_VALUE_A:");
        expected.add("					parent.addSomeDummys(result);");
        expected.add("					break;");
        expected.add("				case ENUM_VALUE_B:");
        expected.add("					parent.addAnotherDummys(result);");
        expected.add("					break;");
        expected.add("				default:");
        expected.add("					log.error(\"There is not any mapping rule for dummy of type {}\", dummy.getAnyField());");
        expected.add("			}");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy) {");
        expected.add("		return convertToDummyDao(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setAnyField(dummy.getAnyField());");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent) {");
        expected.add("		return convertToDummyDao(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.getAggDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }

    @Test
    public void testCreateAccessMapperParentAggregateRefFilterIsNotDomain() {
        setMockReturnsReference(toParentReference, "someDummy", "Owner", "anyField", "ENUM_VALUE_A", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(toParentReference, entity, parentEntity, field);
        when(toParentReference.isReverse()).thenReturn(Boolean.TRUE);
        setMockReturnsReference(anotherToParentReference, "anotherDummy", "Owner", "anyField", "ENUM_VALUE_B", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(anotherToParentReference, entity, parentEntity, field);
        when(anotherToParentReference.isReverse()).thenReturn(Boolean.TRUE);

        setMockReturnsReference(fromParentReference, "someDummy", "Dummy", "anyField", "ENUM_VALUE_A", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(fromParentReference, parentEntity, entity, field);
        setMockReturnsReference(anotherFromParentReference, "anotherDummy", "Dummy", "anyField", "ENUM_VALUE_B", Boolean.TRUE, Boolean.TRUE);
        setMockReturnsReference(anotherFromParentReference, parentEntity, entity, field);

        when(field.getType()).thenReturn("SomeEnum");
        when(field.getTypePackage()).thenReturn("de.test.package.enums");
        when(field.getModels()).thenReturn(Models.DAO);
        when(entity.getParentRefs()).thenReturn(Arrays.asList(toParentReference, anotherToParentReference));
        when(entity.getFields()).thenReturn(Collections.singletonList(field));
        when(parentEntity.getReferences()).thenReturn(Arrays.asList(fromParentReference, anotherFromParentReference));

        List<String> expected = new ArrayList<>();
        expected.add("package de.test.package.mapper;");
        expected.add("");
        expected.add("import de.test.package.dao.IIdentifiableDao;");
        expected.add("import de.test.package.dao.OwnerDao;");
        expected.add("import de.test.package.dao.grouping.DummyDao;");
        expected.add("import de.test.package.domain.IIdentifiable;");
        expected.add("import de.test.package.domain.Owner;");
        expected.add("import de.test.package.domain.grouping.Dummy;");
        expected.add("import de.test.package.enums.SomeEnum;");
        expected.add("import java.util.HashMap;");
        expected.add("import java.util.Map;");
        expected.add("import lombok.extern.log4j.Log4j2;");
        expected.add("");
        expected.add("@Log4j2");
        expected.add("public class GroupingAccessMapper {");
        expected.add("");
        expected.add("	private GroupingAccessMapper() {");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * singleton");
        expected.add("	 */");
        expected.add("	private static GroupingAccessMapper instance;");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy) {");
        expected.add("		return convertToDummy(dummy, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"Dummy\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (Dummy) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		Dummy result = new Dummy();");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent) {");
        expected.add("		return convertToDummy(dummy, parent, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static Dummy convertToDummy(DummyDao dummy, Owner parent, Map<String, IIdentifiable> mappedObjects) {");
        expected.add("		Dummy result = convertToDummy(dummy, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			switch (dummy.getAnyField()) {");
        expected.add("				case ENUM_VALUE_A:");
        expected.add("					parent.addSomeDummys(result);");
        expected.add("					break;");
        expected.add("				case ENUM_VALUE_B:");
        expected.add("					parent.addAnotherDummys(result);");
        expected.add("					break;");
        expected.add("				default:");
        expected.add("					log.error(\"There is not any mapping rule for dummy of type {}\", dummy.getAnyField());");
        expected.add("			}");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, SomeEnum anyField) {");
        expected.add("		return convertToDummyDao(dummy, anyField, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, SomeEnum anyField, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		if (dummy == null) {");
        expected.add("			return null;");
        expected.add("		}");
        expected.add("");
        expected.add("		String identification = \"DummyDao\" + dummy.getId().longValue();");
        expected.add("		if (!mappedObjects.isEmpty() && mappedObjects.containsKey(identification)) {");
        expected.add("			return (DummyDao) mappedObjects.get(identification);");
        expected.add("		}");
        expected.add("");
        expected.add("		DummyDao result = new DummyDao();");
        expected.add("");
        expected.add("		result.setAnyField(anyField);");
        expected.add("");
        expected.add("		mappedObjects.put(identification, result);");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, SomeEnum anyField) {");
        expected.add("		return convertToDummyDao(dummy, parent, anyField, new HashMap<>());");
        expected.add("	}");
        expected.add("");
        expected.add("	public static DummyDao convertToDummyDao(Dummy dummy, OwnerDao parent, SomeEnum anyField, Map<String, IIdentifiableDao> mappedObjects) {");
        expected.add("		DummyDao result = convertToDummyDao(dummy, anyField, mappedObjects);");
        expected.add("		if (result != null) {");
        expected.add("			result.setParentOwner(parent);");
        expected.add("			parent.getAggDummys().add(result);");
        expected.add("		}");
        expected.add("		return result;");
        expected.add("	}");
        expected.add("");
        expected.add("	/**");
        expected.add("	 * @return the singleton");
        expected.add("	 */");
        expected.add("	public static GroupingAccessMapper getInstance() {");
        expected.add("		if (instance == null) {");
        expected.add("			instance = new GroupingAccessMapper();");
        expected.add("		}");
        expected.add("		return instance;");
        expected.add("	}");
        expected.add("");
        expected.add("}");

        assertTrue(cut.createAccessMapper(entities, GROUPING_NAME, MAPPER_PACKAGE_NAME, DAO_PACKAGE_NAME, DOMAIN_PACKAGE_NAME, basePackageDir));

        checkSingleFile(String.format("%sAccessMapper.java", AbstractCreator.getUpperFirst(GROUPING_NAME)), expected);
    }
}
